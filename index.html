<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Partículas IA</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        canvas { display: block; position: fixed; top: 0; left: 0; z-index: 1; }
        
        #ui-container {
            position: absolute; top: 15px; left: 15px; z-index: 10;
            background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(10px);
            padding: 20px; border-radius: 20px; color: white;
            border: 1px solid rgba(255, 255, 255, 0.1); width: 240px;
        }

        select, input, button {
            background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px; width: 100%; border-radius: 10px; margin-top: 10px; outline: none;
        }

        button { background: #00ff88; color: black; font-weight: bold; cursor: pointer; border: none; }

        #video-container { position: fixed; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <div id="ui-container">
        <h2 style="margin:0; color:#00ff88; font-size: 1.2rem;">Partículas IA</h2>
        <select id="shapeSelector">
            <option value="cloud">Nube de Estrellas</option>
            <option value="heart">Corazón 3D </option>
            <option value="saturn">Anillo</option>
            <option value="fireworks">Bomba</option>
        </select>
        <input type="color" id="colorPicker" value="#00ff88">
        <button id="btnRetry">REINTENTAR CÁMARA</button>
        <p style="font-size: 0.7rem; opacity: 0.6; margin-top: 10px;">
            ⚠️ Si falla: Copia el link y pégalo directamente en CHROME.
        </p>
    </div>

    <div id="video-container">
        <video id="input_video" playsinline muted></video>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        // --- MOTOR 3D ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        camera.position.z = 5;

        function createPoints(type) {
            const count = 4000;
            const pos = new Float32Array(count * 3);
            for(let i=0; i<count; i++) {
                let i3 = i*3;
                if(type === 'heart') {
                    const t = Math.random() * Math.PI * 2;
                    pos[i3] = 1.6 * Math.pow(Math.sin(t), 3);
                    pos[i3+1] = 1.3 * Math.cos(t) - 0.5 * Math.cos(2*t) - 0.2 * Math.cos(3*t) - 0.1 * Math.cos(4*t);
                } else if(type === 'saturn') {
                    const r = Math.random() > 0.4 ? 1.5 : 3;
                    const a = Math.random() * Math.PI * 2;
                    pos[i3] = Math.cos(a) * r; pos[i3+1] = Math.sin(a) * (r > 2 ? 0.1 : 1.5); pos[i3+2] = Math.sin(a) * r;
                } else if(type === 'fireworks') {
                    const r = Math.random() * 3; const a = Math.random() * 6.28; const b = Math.random() * 6.28;
                    pos[i3] = r * Math.sin(a) * Math.cos(b); pos[i3+1] = r * Math.sin(a) * Math.sin(b); pos[i3+2] = r * Math.cos(a);
                } else {
                    pos[i3] = (Math.random()-0.5)*8; pos[i3+1] = (Math.random()-0.5)*8; pos[i3+2] = (Math.random()-0.5)*8;
                }
            }
            return pos;
        }

        const geo = new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.BufferAttribute(createPoints('cloud'), 3));
        const mat = new THREE.PointsMaterial({ size: 0.06, color: 0x00ff88, transparent: true, blending: THREE.AdditiveBlending });
        const particles = new THREE.Points(geo, mat);
        scene.add(particles);

        // --- MANOS IA ---
        const videoElement = document.getElementById('input_video');
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        
        hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5 });
        hands.onResults(results => {
            if (results.multiHandLandmarks && results.multiHandLandmarks[0]) {
                const lm = results.multiHandLandmarks[0];
                particles.rotation.y = (lm[9].x - 0.5) * 4;
                particles.rotation.x = (lm[9].y - 0.5) * 4;
                const d = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                const s = Math.max(0.3, d * 10);
                particles.scale.set(s, s, s);
            }
        });

        const cam = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 740, height: 580
        });

        function startCamera() {
            cam.start().catch(err => {
                alert("ERROR: Abre este link en CHROME directamente, no desde otra app.");
            });
        }

        startCamera();
        document.getElementById('btnRetry').onclick = startCamera;

        // UI Events
        document.getElementById('shapeSelector').onchange = (e) => {
            particles.geometry.setAttribute('position', new THREE.BufferAttribute(createPoints(e.target.value), 3));
        };
        document.getElementById('colorPicker').oninput = (e) => {
            particles.material.color.set(e.target.value);
        };

        function animate() {
            requestAnimationFrame(animate);
            particles.rotation.z += 0.001;
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
